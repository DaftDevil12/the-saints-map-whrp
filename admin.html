<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The Saints â€“ Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    background: linear-gradient(to bottom right, #0f172a, #1e293b);
    color: #e2e8f0;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
  }
  .card { background: rgba(30,41,59,0.8); border:1px solid rgba(59,130,246,0.4); padding:20px; border-radius:12px; backdrop-filter:blur(6px); }
  .btn { padding:6px 10px; border-radius:6px; font-weight:600; }
  .btn-blue { background:#3b82f6; }
  .btn-red { background:#dc2626; }
  .btn-yellow { background:#f59e0b; }
  .btn-green { background:#10b981; }
</style>
</head>

<body class="p-6">

<a href="index.html" class="text-blue-400 underline mb-4 inline-block">â¬… Back to Dashboard</a>

<h1 class="text-3xl font-bold text-blue-400 mb-6">ðŸ›¡ Admin Panel</h1>

<!-- CREATE ACCOUNT -->
<div class="card mb-8">
  <h2 class="text-xl font-bold mb-3">Create New Account</h2>
  <input id="new-username" class="w-full mb-3 p-2 rounded bg-gray-900 border border-gray-700" placeholder="Username">
  <button id="create-btn" class="btn btn-blue w-full">Create Account (One-Time Password)</button>
</div>

<!-- USER LIST -->
<h2 class="text-xl font-bold mb-3">All Users</h2>
<div id="users-list" class="space-y-3"></div>

<!-- FIREBASE -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, getDocs, collection } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
  authDomain: "the-saints-2f622.firebaseapp.com",
  projectId: "the-saints-2f622",
  storageBucket: "the-saints-2f622.firebasestorage.app",
  messagingSenderId: "131705359242",
  appId: "1:131705359242:web:92fa93f8a10a8ae34a5673"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Verify session
const raw = localStorage.getItem("saintsUser");
if (!raw) window.location.href = "login.html";
let sessionUser = JSON.parse(raw);
if (sessionUser.username !== "Dante-Alberts") window.location.href = "index.html";

// Load Users
async function loadUsers() {
  const snap = await getDocs(collection(db, "users"));
  const list = document.getElementById("users-list");
  list.innerHTML = "";

  snap.forEach(docSnap => {
    const u = docSnap.data();

    const row = document.createElement("div");
    row.className = "card flex justify-between items-center";

    row.innerHTML = `
      <div>
        <div class="text-lg font-bold">${u.username}</div>
        <div class="text-sm text-gray-400">Role: ${u.role}</div>
        <div class="text-sm text-gray-400">Approved: ${u.approved}</div>
      </div>

      <div class="flex gap-2">
        <button class="btn btn-yellow" data-reset="${u.username}">Reset PW</button>
        <button class="btn btn-blue" data-openmap="${u.username}">Open Map</button>
        <button class="btn btn-green" data-promote="${u.username}">Promote</button>
        <button class="btn btn-red" data-demote="${u.username}">Demote</button>
        <button class="btn btn-red" data-delete="${u.username}">Delete</button>
      </div>
    `;

    list.appendChild(row);
  });

  // attach events
  document.querySelectorAll("[data-reset]").forEach(btn=>{
    btn.onclick = ()=>resetPW(btn.dataset.reset);
  });
  document.querySelectorAll("[data-openmap]").forEach(btn=>{
    btn.onclick = ()=>openMap(btn.dataset.openmap);
  });
  document.querySelectorAll("[data-promote]").forEach(btn=>{
    btn.onclick = ()=>promote(btn.dataset.promote);
  });
  document.querySelectorAll("[data-demote]").forEach(btn=>{
    btn.onclick = ()=>demote(btn.dataset.demote);
  });
  document.querySelectorAll("[data-delete]").forEach(btn=>{
    btn.onclick = ()=>deleteUser(btn.dataset.delete);
  });
}

loadUsers();

// Create account
document.getElementById("create-btn").onclick = async () => {
  const username = document.getElementById("new-username").value.trim();
  if (!username) return alert("Enter a username");

  const oneTimePassword = Math.random().toString(36).slice(2, 8);

  await setDoc(doc(db, "users", username), {
    username,
    password: oneTimePassword,
    role: "untrusted",
    approved: true,
    mustReset: true
  });

  alert("Account created!\nOne-time password: " + oneTimePassword);
  loadUsers();
};

// Reset password
async function resetPW(username) {
  const newPW = Math.random().toString(36).slice(2, 8);
  await updateDoc(doc(db, "users", username), {
    password: newPW,
    mustReset: true
  });
  alert("Temporary password for " + username + ": " + newPW);
}

// Promote / demote
async function promote(username) {
  await updateDoc(doc(db, "users", username), { role: "trusted" });
  loadUsers();
}
async function demote(username) {
  await updateDoc(doc(db, "users", username), { role: "untrusted" });
  loadUsers();
}

// Open user map
function openMap(username) {
  window.location.href = "personal-map.html?user=" + username + "&admin=true";
}
</script>

</body>
</html>
