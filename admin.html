<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Saints - Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc, 
    getDocs,
    collection,
    deleteDoc
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
    authDomain: "the-saints-2f622.firebaseapp.com",
    projectId: "the-saints-2f622",
    storageBucket: "the-saints-2f622.firebasestorage.app",
    messagingSenderId: "131705359242",
    appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
    measurementId: "G-36PY404Q8N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let adminUser = null;

  document.addEventListener("DOMContentLoaded", async () => {
    // Check local login
    const stored = localStorage.getItem("saintsUser");
    if (!stored) return window.location.href = "login.html";

    adminUser = JSON.parse(stored);
    if (adminUser.role !== "admin") {
      alert("Admins only.");
      return window.location.href = "index.html";
    }

    loadUsers();
  });

  // Load users into table
  async function loadUsers() {
    const q = await getDocs(collection(db, "users"));
    const container = document.getElementById("user-list");
    container.innerHTML = "";

    q.forEach(docSnap => {
      const u = docSnap.data();

      container.innerHTML += `
        <div class="p-3 border-b border-gray-700 flex justify-between items-center">
          <div>
            <p class="font-bold">${u.username}</p>
            <p class="text-sm opacity-70">${u.role.toUpperCase()}</p>
            <p class="text-sm ${u.approved ? 'text-green-400' : 'text-red-400'}">
              ${u.approved ? "APPROVED" : "PENDING"}
            </p>
          </div>

          <div class="flex gap-2">
            ${!u.approved ? `<button class="approve-btn bg-green-600 px-3 py-1" data-user="${u.username}">Approve</button>` : ""}
            ${u.role !== "admin" ? `<button class="admin-btn bg-blue-600 px-3 py-1" data-user="${u.username}">Make Admin</button>` : ""}
            <button class="delete-btn bg-red-600 px-3 py-1" data-user="${u.username}">Delete</button>
          </div>
        </div>
      `;
    });

    // Add listeners
    document.querySelectorAll(".approve-btn").forEach(b =>
      b.addEventListener("click", () => approveUser(b.dataset.user))
    );

    document.querySelectorAll(".admin-btn").forEach(b =>
      b.addEventListener("click", () => makeAdmin(b.dataset.user))
    );

    document.querySelectorAll(".delete-btn").forEach(b =>
      b.addEventListener("click", () => deleteUser(b.dataset.user))
    );
  }

  async function approveUser(username) {
    await setDoc(doc(db, "users", username), { approved: true }, { merge: true });
    loadUsers();
  }

  async function makeAdmin(username) {
    await setDoc(doc(db, "users", username), { role: "admin", approved: true }, { merge: true });
    loadUsers();
  }

  async function deleteUser(username) {
    if (!confirm("Delete this user?")) return;
    await deleteDoc(doc(db, "users", username));
    loadUsers();
  }
</script>

<style>
  body {
    background: #0b1120;
    color: white;
    font-family: 'Orbitron', sans-serif;
  }
</style>
</head>

<body class="p-10">
  <h1 class="text-4xl font-bold mb-6">THE SAINTS ADMIN PANEL</h1>

  <div id="user-list" class="bg-black bg-opacity-40 border border-blue-900 rounded p-4"></div>
</body>
</html>
