<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The Saints â€“ Admin Panel</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    background: linear-gradient(to bottom right, #020617, #0f172a);
    color: #e5e7eb;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
  }
  .card {
    background: rgba(15,23,42,0.9);
    border-radius: 16px;
    border: 1px solid rgba(59,130,246,0.5);
    padding: 20px;
    box-shadow: 0 12px 30px rgba(0,0,0,0.5);
  }
</style>
</head>
<body class="p-6">
  <img src="watermark.png" style="position:fixed;top:20px;right:20px;width:120px;opacity:.5;pointer-events:none;" />

  <a href="index.html" class="text-blue-400 underline mb-4 inline-block">â¬… Back to Dashboard</a>
  <h1 class="text-3xl font-bold text-blue-400 mb-6">ðŸ›¡ Admin Control Panel</h1>

  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <!-- User approval & roles -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3 text-rose-300">User Approvals & Roles</h2>
      <div id="pending-users" class="mb-5">
        <h3 class="text-sm font-semibold text-gray-300 mb-2">Pending Approvals</h3>
        <div id="pending-list" class="space-y-2 text-sm text-gray-200"></div>
      </div>

      <div>
        <h3 class="text-sm font-semibold text-gray-300 mb-2">Existing Users</h3>
        <div id="user-list" class="space-y-2 text-sm text-gray-200"></div>
      </div>
    </div>

    <!-- Password reset requests -->
    <div class="card">
      <h2 class="text-xl font-semibold mb-3 text-blue-300">Password Reset Requests</h2>
      <p class="text-xs text-gray-400 mb-3">
        All new or reset passwords are <span class="font-semibold">one-time</span>. Users are forced to change them on next login.
      </p>
      <div id="reset-list" class="space-y-2 text-sm text-gray-200"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import {
      getFirestore,
      doc,
      getDoc,
      updateDoc,
      collection,
      getDocs,
      setDoc,
      deleteDoc,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
      authDomain: "the-saints-2f622.firebaseapp.com",
      projectId: "the-saints-2f622",
      storageBucket: "the-saints-2f622.firebasestorage.app",
      messagingSenderId: "131705359242",
      appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
      measurementId: "G-36PY404Q8N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // ---- Admin gate ----
    const raw = localStorage.getItem("saintsUser");
    if (!raw) window.location.href = "login.html";

    let sessionUser;
    try { sessionUser = JSON.parse(raw); } catch {
      localStorage.removeItem("saintsUser");
      window.location.href = "login.html";
    }

    async function ensureAdmin() {
      const ref = doc(db, "users", sessionUser.username);
      const snap = await getDoc(ref);
      if (!snap.exists() || (snap.data().role !== "admin")) {
        window.location.href = "index.html";
      }
    }

    await ensureAdmin();

    // ---- Helpers ----
    function formatTime(ts) {
      if (!ts) return "";
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      return d.toLocaleString();
    }

    function generatePassword(len = 10) {
      const chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz23456789!@#$%";
      let out = "";
      for (let i = 0; i < len; i++) {
        out += chars[Math.floor(Math.random() * chars.length)];
      }
      return out;
    }

    // ---- Load pending approvals & users ----
    async function loadUsers() {
      const col = collection(db, "users");
      const snaps = await getDocs(col);

      const pendingContainer = document.getElementById("pending-list");
      const userContainer = document.getElementById("user-list");
      pendingContainer.innerHTML = "";
      userContainer.innerHTML = "";

      snaps.forEach(snap => {
        const data = snap.data();
        const username = snap.id;
        const role = data.role || "untrusted";
        const approved = !!data.approved;

        if (!approved) {
          const div = document.createElement("div");
          div.className = "flex items-center justify-between bg-slate-800/60 rounded-md px-3 py-2";

          div.innerHTML = `
            <div>
              <div class="font-semibold">${username}</div>
              <div class="text-xs text-gray-400">Role: ${role}</div>
            </div>
            <div class="flex gap-2">
              <button data-approve="${username}" class="px-2 py-1 text-xs bg-green-600 rounded-md">Approve</button>
              <button data-deny="${username}" class="px-2 py-1 text-xs bg-red-600 rounded-md">Delete</button>
            </div>
          `;
          pendingContainer.appendChild(div);
        }

        // existing users
        const row = document.createElement("div");
        row.className = "flex items-center justify-between bg-slate-800/60 rounded-md px-3 py-2";

        row.innerHTML = `
          <div>
            <div class="font-semibold">${username}</div>
            <div class="text-xs text-gray-400">Role: ${role} â€¢ Approved: ${approved}</div>
          </div>
          <div class="flex gap-2 items-center">
            <select data-role="${username}" class="bg-slate-900 border border-slate-600 text-xs rounded px-2 py-1">
              <option value="untrusted"${role==="untrusted"?" selected":""}>Untrusted</option>
              <option value="trusted"${role==="trusted"?" selected":""}>Trusted</option>
              <option value="admin"${role==="admin"?" selected":""}>Admin</option>
            </select>
            <button data-save-role="${username}" class="px-2 py-1 text-xs bg-blue-600 rounded-md">Save</button>
          </div>
        `;
        userContainer.appendChild(row);
      });

      // Handlers
      document.querySelectorAll("[data-approve]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.approve;
          await updateDoc(doc(db, "users", u), { approved: true });
          loadUsers();
        };
      });

      document.querySelectorAll("[data-deny]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.deny;
          await deleteDoc(doc(db, "users", u));
          loadUsers();
        };
      });

      document.querySelectorAll("[data-save-role]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.saveRole;
          const sel = document.querySelector(`[data-role="${u}"]`);
          await updateDoc(doc(db, "users", u), { role: sel.value });
          loadUsers();
        };
      });
    }

    // ---- Load password reset requests ----
    async function loadResets() {
      const col = collection(db, "passwordResets");
      const snaps = await getDocs(col);
      const container = document.getElementById("reset-list");
      container.innerHTML = "";

      if (snaps.empty) {
        container.innerHTML = `<div class="text-xs text-gray-500">No pending password reset requests.</div>`;
        return;
      }

      snaps.forEach(snap => {
        const data = snap.data();
        const username = data.username || snap.id;
        const row = document.createElement("div");
        row.className = "flex items-center justify-between bg-slate-800/60 rounded-md px-3 py-2";

        row.innerHTML = `
          <div>
            <div class="font-semibold">${username}</div>
            <div class="text-xs text-gray-400">Requested: ${formatTime(data.requestedAt)}</div>
          </div>
          <div class="flex gap-2">
            <button data-gen="${username}" class="px-2 py-1 text-xs bg-indigo-600 rounded-md">Generate</button>
            <button data-manual="${username}" class="px-2 py-1 text-xs bg-amber-500 rounded-md">Manual</button>
            <button data-deny-reset="${username}" class="px-2 py-1 text-xs bg-red-600 rounded-md">Deny</button>
          </div>
        `;
        container.appendChild(row);
      });

      // Generate temp password (one-time)
      document.querySelectorAll("[data-gen]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.gen;
          const tempPw = generatePassword(10);

          await updateDoc(doc(db, "users", u), {
            password: tempPw,
            mustChangePassword: true
          });

          await deleteDoc(doc(db, "passwordResets", u));

          alert(`Temporary one-time password for ${u}:\n\n${tempPw}\n\nShare this with them. They must set a new password after logging in.`);
          loadResets();
        };
      });

      // Manual password
      document.querySelectorAll("[data-manual]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.manual;
          const pw = prompt("Enter a temporary one-time password (min 4 characters):");
          if (!pw) return;
          if (pw.length < 4) {
            alert("Password must be at least 4 characters.");
            return;
          }

          await updateDoc(doc(db, "users", u), {
            password: pw,
            mustChangePassword: true
          });

          await deleteDoc(doc(db, "passwordResets", u));

          alert(`Temporary one-time password set for ${u}. They will be forced to choose a new one on login.`);
          loadResets();
        };
      });

      // Deny request
      document.querySelectorAll("[data-deny-reset]").forEach(btn => {
        btn.onclick = async () => {
          const u = btn.dataset.denyReset;
          await deleteDoc(doc(db, "passwordResets", u));
          loadResets();
        };
      });
    }

    loadUsers();
    loadResets();
  </script>
</body>
</html>
