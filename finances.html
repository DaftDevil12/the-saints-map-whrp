<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The Saints - Finances</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body {
    background: linear-gradient(to bottom right, #0f172a, #1e293b);
    color: #e2e8f0;
    font-family: 'Inter', sans-serif;
    height: 100vh;
    overflow: hidden;
  }

  #top-watermark {
    position: fixed;
    top: 20px;
    right: 20px;
    width: 120px;
    opacity: 0.5;
    pointer-events: none;
  }

  #bottom-watermark {
    position: fixed;
    bottom: 10px;
    left: 50%;
    transform: translateX(-50%);
    opacity: 0.6;
    font-size: 12px;
    color: #94a3b8;
  }

  .card {
    background: rgba(30, 41, 59, 0.85);
    border: 1px solid rgba(59, 130, 246, 0.4);
    padding: 20px;
    border-radius: 12px;
    backdrop-filter: blur(6px);
  }
</style>
</head>

<body>

<img id="top-watermark" src="watermark.png">
<div id="bottom-watermark">Made by Dante Alberts</div>

<!-- Dashboard -->
<a href="index.html"
   class="absolute top-5 left-5 bg-gray-800 hover:bg-gray-700 px-4 py-2 rounded-md text-sm border border-blue-400 shadow-xl">
â¬… Dashboard
</a>

<div class="flex flex-col items-center pt-20 px-5">

  <h1 class="text-3xl font-bold text-blue-400 mb-2">ðŸ’° Saints Finances</h1>
  <p class="text-gray-400 mb-6">View and manage financial entries</p>

  <!-- Total Balance Display -->
  <div class="card w-full max-w-xl mb-6">
    <div class="flex justify-between items-center">
      <h2 class="text-xl font-semibold">Current Balance</h2>
      <p id="total-balance" class="text-3xl font-bold">$0</p>
    </div>
  </div>

  <!-- Add Entry (trusted/admin only) -->
  <div id="add-section" class="card w-full max-w-xl mb-8 hidden">
    <h2 class="text-xl font-semibold mb-3">Add Entry</h2>

    <div class="flex flex-col gap-3">

      <input id="entry-title"
             class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"
             placeholder="Title (e.g. Ammo Purchase)">

      <input id="entry-amount"
             class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"
             placeholder="Amount (e.g. -500 or +1200)">

      <textarea id="entry-notes"
                class="px-3 py-2 rounded-md bg-gray-700 border border-gray-600"
                placeholder="Notes (optional)"
                rows="3"></textarea>

      <button id="add-entry-btn"
        class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md">
        âž• Add Entry
      </button>
    </div>
  </div>

  <!-- Finance Log -->
  <div class="card w-full max-w-3xl overflow-y-auto" style="max-height: 60vh;">
    <h2 class="text-2xl font-semibold mb-4">Finance Log</h2>

    <div id="finance-list" class="flex flex-col gap-4">
      <p class="text-gray-500">Loading...</p>
    </div>
  </div>

</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { 
    getFirestore, 
    collection,
    addDoc,
    onSnapshot,
    query,
    orderBy,
    getDoc,
    doc
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
    authDomain: "the-saints-2f622.firebaseapp.com",
    projectId: "the-saints-2f622",
    storageBucket: "the-saints-2f622.firebasestorage.app",
    messagingSenderId: "131705359242",
    appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
    measurementId: "G-36PY404Q8N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Load session user
  const raw = localStorage.getItem("saintsUser");
  if (!raw) window.location.href = "login.html";

  let user;
  try { user = JSON.parse(raw); }
  catch { window.location.href = "login.html"; }

  // Load user role from Firestore
  async function loadRole() {
    const snap = await getDoc(doc(db, "users", user.username));
    if (!snap.exists()) {
      localStorage.removeItem("saintsUser");
      window.location.href = "login.html";
      return;
    }

    const role = snap.data().role || "untrusted";

    if (role === "trusted" || role === "admin") {
      document.getElementById("add-section").classList.remove("hidden");
    }
  }

  loadRole();

  const listEl = document.getElementById("finance-list");
  const totalEl = document.getElementById("total-balance");

  // Display finance entries
  const q = query(collection(db, "finances"), orderBy("timestamp", "desc"));

  onSnapshot(q, (snapshot) => {
    listEl.innerHTML = "";
    
    // Calculate total
    let total = 0;
    
    if (snapshot.empty) {
      listEl.innerHTML = `<p class="text-gray-500">No entries yet.</p>`;
      totalEl.textContent = "$0";
      totalEl.className = "text-3xl font-bold text-gray-400";
      return;
    }

    snapshot.forEach(doc => {
      const f = doc.data();
      total += f.amount;

      const color = f.amount >= 0 ? "text-green-400" : "text-red-400";

      const item = document.createElement("div");
      item.className = "p-4 rounded-md bg-gray-800 border border-gray-700";

      item.innerHTML = `
        <div class="flex justify-between">
          <h3 class="text-xl font-bold">${f.title}</h3>
          <p class="font-bold ${color}">${f.amount >= 0 ? '+' : ''}${f.amount}</p>
        </div>
        <p class="text-gray-400 text-sm mt-1">${f.notes || ""}</p>
        <p class="text-xs text-gray-500 mt-2">Added by: ${f.author}</p>
      `;

      listEl.appendChild(item);
    });

    // Update total display
    totalEl.textContent = `$${total.toLocaleString()}`;
    if (total > 0) {
      totalEl.className = "text-3xl font-bold text-green-400";
    } else if (total < 0) {
      totalEl.className = "text-3xl font-bold text-red-400";
    } else {
      totalEl.className = "text-3xl font-bold text-gray-400";
    }
  });

  // Add finance entry
  document.getElementById("add-entry-btn").onclick = async () => {
    const title = document.getElementById("entry-title").value.trim();
    const amount = parseFloat(document.getElementById("entry-amount").value.trim());
    const notes = document.getElementById("entry-notes").value.trim();

    if (!title || isNaN(amount)) {
      alert("Please enter a valid title and numeric amount.");
      return;
    }

    await addDoc(collection(db, "finances"), {
      title: title,
      amount: amount,
      notes: notes,
      author: user.username,
      timestamp: Date.now()
    });

    // Clear input
    document.getElementById("entry-title").value = "";
    document.getElementById("entry-amount").value = "";
    document.getElementById("entry-notes").value = "";
  };
</script>

</body>
</html>
