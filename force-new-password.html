<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The Saints â€“ Set New Password</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body {
    background: linear-gradient(to bottom right, #020617, #0f172a);
    color: #e5e7eb;
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  .card {
    background: rgba(15,23,42,0.95);
    border-radius: 16px;
    border: 1px solid rgba(59,130,246,0.5);
    padding: 24px;
    box-shadow: 0 20px 40px rgba(0,0,0,0.6);
    max-width: 420px;
    width: 100%;
  }
</style>
</head>
<body>
  <img id="top-watermark" src="watermark.png" style="position:fixed;top:20px;right:20px;width:120px;opacity:.6;pointer-events:none;" />

  <div class="card">
    <h1 class="text-xl font-bold text-blue-400 mb-2">Set a New Password</h1>
    <p class="text-sm text-gray-300 mb-4">
      Your previous password was temporary. Choose a new permanent password (4+ characters).
    </p>

    <input id="pw1" type="password" class="w-full px-3 py-2 rounded-md bg-slate-900 border border-slate-700 text-sm mb-3" placeholder="New password" />
    <input id="pw2" type="password" class="w-full px-3 py-2 rounded-md bg-slate-900 border border-slate-700 text-sm mb-4" placeholder="Confirm new password" />

    <button id="save-btn"
      class="w-full py-2 rounded-md bg-blue-600 hover:bg-blue-500 text-white font-semibold text-sm">
      Save Password
    </button>

    <p id="status" class="mt-4 text-xs text-gray-400"></p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
      authDomain: "the-saints-2f622.firebaseapp.com",
      projectId: "the-saints-2f622",
      storageBucket: "the-saints-2f622.firebasestorage.app",
      messagingSenderId: "131705359242",
      appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
      measurementId: "G-36PY404Q8N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const raw = localStorage.getItem("saintsUser");
    if (!raw) {
      window.location.href = "login.html";
    }

    let user;
    try {
      user = JSON.parse(raw);
    } catch {
      localStorage.removeItem("saintsUser");
      window.location.href = "login.html";
    }

    document.getElementById("save-btn").onclick = async () => {
      const pw1 = document.getElementById("pw1").value;
      const pw2 = document.getElementById("pw2").value;
      const status = document.getElementById("status");

      if (!pw1 || !pw2) {
        alert("Enter and confirm your new password.");
        return;
      }
      if (pw1 !== pw2) {
        alert("Passwords do not match.");
        return;
      }
      if (pw1.length < 4) {
        alert("Password must be at least 4 characters.");
        return;
      }

      const userRef = doc(db, "users", user.username);
      const snap = await getDoc(userRef);
      if (!snap.exists()) {
        alert("User record missing. Please contact an admin.");
        return;
      }

      await updateDoc(userRef, {
        password: pw1,
        mustChangePassword: false
      });

      status.textContent = "Password updated. Redirecting to dashboard...";
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1000);
    };
  </script>
</body>
</html>
