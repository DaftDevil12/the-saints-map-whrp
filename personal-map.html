<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Personal Map - The Saints</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #0f172a; }
    #map { position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: 0; }
    #watermark {
      position: fixed;
      bottom: 10px;
      right: 10px;
      width: 120px;
      opacity: 0.6;
      pointer-events: none;
      z-index: 9999;
    }
    .toolbar {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(30,41,59,0.95);
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.4);
      z-index: 1000;
      color: white;
      width: 300px;
    }
  </style>
</head>
<body>

<img id="watermark" src="watermark.png" alt="Watermark" />
<div class="toolbar">
  <h2 class="text-lg font-bold text-blue-400 mb-2">Personal Drawing Tools</h2>
  <p class="text-sm text-gray-300 mb-4">This map is only visible to you.</p>
  <button id="clear-btn" class="px-4 py-2 bg-red-600 hover:bg-red-500 rounded text-white w-full">ðŸ—‘ Clear Map</button>
</div>
<div id="map"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  const config = {
    apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
    authDomain: "the-saints-2f622.firebaseapp.com",
    projectId: "the-saints-2f622",
    storageBucket: "the-saints-2f622.firebasestorage.app",
    messagingSenderId: "131705359242",
    appId: "1:131705359242:web:92fa93f8a10a8ae34a5673"
  };

  const app = initializeApp(config);
  const db = getFirestore(app);

  const raw = localStorage.getItem("saintsUser");
  if (!raw) window.location.href = "login.html";

  const user = JSON.parse(raw);
  const docId = `personal-${user.username}`;
  const docRef = doc(db, "maps", docId);

  let map, drawnLayer;

  function initMap() {
    map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 4,
      maxNativeZoom: 4,
      center: [0, 0],
      zoom: 0,
    });

    const bounds = [[-256, -256], [256, 256]];
    L.tileLayer('https://dukeofsussex.dev/projects/gta-v-map/maps/satellite/{z}/{x}/{y}.webp', {
      minZoom: -2,
      maxZoom: 4,
      noWrap: true,
      tileSize: 256,
      bounds,
      attribution: 'Â© Rockstar Games | GTA V UHD Map'
    }).addTo(map);

    map.setMaxBounds(bounds);
    map.fitBounds(bounds);

    drawnLayer = L.featureGroup().addTo(map);
    map.on('click', onMapClick);
    loadSavedData();
  }

  function onMapClick(e) {
    const marker = L.circleMarker(e.latlng, { radius: 8, color: '#3b82f6' });
    marker.addTo(drawnLayer);
    saveData();
  }

  async function loadSavedData() {
    const snap = await getDoc(docRef);
    if (!snap.exists()) return;
    const { points = [] } = snap.data();
    points.forEach(p => {
      const marker = L.circleMarker([p.lat, p.lng], { radius: 8, color: '#3b82f6' });
      marker.addTo(drawnLayer);
    });
  }

  async function saveData() {
    const points = [];
    drawnLayer.eachLayer(layer => {
      const { lat, lng } = layer.getLatLng();
      points.push({ lat, lng });
    });
    await setDoc(docRef, { points });
  }

  document.getElementById('clear-btn').onclick = async () => {
    if (confirm('Clear all markers?')) {
      drawnLayer.clearLayers();
      await setDoc(docRef, { points: [] });
    }
  }

  initMap();
</script>
</body>
</html>
