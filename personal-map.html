<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>The Saints â€“ Personal Map</title>

<script src="https://cdn.tailwindcss.com"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>

<style>
  html, body { margin:0; padding:0; height:100%; overflow:hidden; }
  #map { position:absolute; top:0; left:0; right:0; bottom:0; }

  .toolbar {
    position:absolute;
    top:20px;
    right:20px;
    background:white;
    padding:15px;
    border-radius:8px;
    z-index:1000;
    max-width:300px;
    box-shadow:0 4px 12px rgba(0,0,0,0.3);
  }

  #watermark {
    position:fixed;
    bottom:15px;
    right:15px;
    width:140px;
    opacity:0.55;
    pointer-events:none;
    z-index:9999;
  }

  .admin-banner {
    position:absolute;
    top:15px;
    left:20px;
    background:rgba(220,38,38,0.9);
    padding:8px 12px;
    color:white;
    font-weight:bold;
    border-radius:6px;
    z-index:1200;
    border:1px solid rgba(255,255,255,0.3);
  }

  .dash-btn {
    position:absolute;
    top:20px;
    left:20px;
    z-index:1000;
    background:#1f2937;
    color:white;
    padding:10px 14px;
    border-radius:6px;
    border:1px solid #3b82f6;
  }
</style>
</head>

<body>

<a href="index.html" class="dash-btn">â¬… Dashboard</a>

<img id="watermark" src="watermark.png" />

<div id="admin-banner" class="admin-banner hidden">
  ADMIN: Viewing Another Userâ€™s Map
</div>

<div id="map"></div>

<div class="toolbar">
  <h3 class="text-lg font-bold mb-3">Personal Drawing Tools</h3>

  <button id="tool-pan" class="px-3 py-2 bg-gray-700 text-white rounded mb-1 w-full">ğŸ–ï¸ Pan</button>
  <button id="tool-draw" class="px-3 py-2 bg-gray-700 text-white rounded mb-1 w-full">âœï¸ Draw</button>
  <button id="tool-text" class="px-3 py-2 bg-gray-700 text-white rounded mb-3 w-full">ğŸ“ Text</button>

  <input id="text-input" class="w-full mb-3 p-2 border rounded" placeholder="Label text..." value="Note">

  <button id="clear-all" class="w-full bg-red-600 text-white py-2 rounded">
    ğŸ—‘ï¸ Clear Map
  </button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, onSnapshot
} from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

// Firebase
const firebaseConfig = {
  apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
  authDomain: "the-saints-2f622.firebaseapp.com",
  projectId: "the-saints-2f622",
  storageBucket: "the-saints-2f622.firebasestorage.app",
  messagingSenderId: "131705359242",
  appId: "1:131705359242:web:92fa93f8a10a8ae34a5673"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// Parse URL
const params = new URLSearchParams(window.location.search);
const adminView = params.get("admin") === "true";
const targetUser = params.get("user");

// Get session user
const raw = localStorage.getItem("saintsUser");
if (!raw) window.location.href = "login.html";

let sessionUser = JSON.parse(raw);
let activeUser = sessionUser.username;

if (adminView && targetUser) {
  activeUser = targetUser;
  document.getElementById("admin-banner").classList.remove("hidden");
}

// Firestore doc path
const mapRef = doc(db, "personalMaps", activeUser);

// Map variables
let map;
let currentTool = "pan";
let isDrawing = false;
let tempLine = [];

let lines = [];
let labels = [];
let isSyncing = false;

// Initialize map
function initMap() {
  map = L.map('map', {
    crs: L.CRS.Simple,
    minZoom: -2,
    maxZoom: 4,
    zoomSnap: 0.25,
    zoomDelta: 0.5,
    zoom: 0,
    center: [0,0]
  });

  const bounds = [[-256,-256],[256,256]];

  L.tileLayer('https://dukeofsussex.dev/projects/gta-v-map/maps/satellite/{z}/{x}/{y}.webp',{
    minZoom:-2, maxZoom:4, noWrap:true, tileSize:256, bounds
  }).addTo(map);

  map.setMaxBounds(bounds);
}

// Draw lines
function redrawLines() {
  map.eachLayer(layer=>{
    if (layer.options && layer.options.isLine) map.removeLayer(layer);
  });
  lines.forEach(line=>{
    const layer = L.polyline(line.points,{color:"red",weight:3,isLine:true}).addTo(map);

    layer.on("click", async ()=>{
      if (!confirm("Delete line?")) return;
      lines = lines.filter(l=>l.id!==line.id);
      redrawLines(); save();
    });
  });
}

// Draw labels
function redrawLabels() {
  labels.forEach(lbl => lbl.marker.remove());
  labels = labels.map(lbl=>{
    const marker = L.marker([lbl.lat,lbl.lng],{
      icon:L.divIcon({
        className:"",
        html:`<div style="padding:4px 8px;background:red;color:white;border-radius:6px;border:2px solid red;font-weight:bold">${lbl.text}</div>`
      }),
      draggable:true
    }).addTo(map);

    marker.on("dragend",async()=>{
      const pos = marker.getLatLng();
      lbl.lat = pos.lat; lbl.lng = pos.lng;
      save();
    });

    return {...lbl, marker};
  });
}

// Load data
async function load() {
  const snap = await getDoc(mapRef);
  if (!snap.exists()) return;
  const data = snap.data();

  lines = data.lines || [];
  labels = data.labels || [];

  redrawLines();
  redrawLabels();
}

// Save data
async function save() {
  await setDoc(mapRef,{
    username: activeUser,
    lines: lines.map(l=>({id:l.id,points:l.points})),
    labels: labels.map(l=>({id:l.id,text:l.text,lat:l.lat,lng:l.lng}))
  });
}

// Tools
document.getElementById("tool-pan").onclick = ()=>currentTool="pan";
document.getElementById("tool-draw").onclick = ()=>currentTool="draw";
document.getElementById("tool-text").onclick = ()=>currentTool="text";

// Clear
document.getElementById("clear-all").onclick = async ()=>{
  if (!confirm("Clear your entire personal map?")) return;
  lines=[]; labels=[];
  redrawLines(); redrawLabels();
  await save();
};

// Map interactions
function setupInteractions() {
  map.on("mousedown",e=>{
    if (currentTool==="draw") {
      isDrawing=true;
      tempLine=[[e.latlng.lat,e.latlng.lng]];
    }
  });

  map.on("mousemove",e=>{
    if (isDrawing && currentTool==="draw") {
      tempLine.push([e.latlng.lat,e.latlng.lng]);
      redrawLines();
      const preview = L.polyline(tempLine,{color:"red",weight:2,isLine:true}).addTo(map);
    }
  });

  map.on("mouseup",async e=>{
    if (isDrawing && currentTool==="draw") {
      isDrawing=false;
      lines.push({
        id:"ln"+Date.now(),
        points:tempLine
      });
      tempLine=[];
      redrawLines();
      await save();
    }
  });

  map.on("click",async e=>{
    if (currentTool==="text") {
      const text = document.getElementById("text-input").value || "Note";
      const lbl = {
        id:"lbl"+Date.now(),
        text,
        lat:e.latlng.lat,
        lng:e.latlng.lng
      };
      labels.push(lbl);
      redrawLabels();
      await save();
    }
  });
}

// INIT
initMap();
setupInteractions();
load();

// Live updates (only for admin viewing other map)
onSnapshot(mapRef,(snap)=>{
  if (!snap.exists()) return;
  if (!adminView) return; // user shouldn't get real-time sync
  const data = snap.data();
  lines = data.lines || [];
  labels = data.labels || [];
  redrawLines(); redrawLabels();
});

</script>

</body>
</html>
