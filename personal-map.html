<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SAINTS_NET://MAP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" rel="stylesheet" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');
    
    html, body { 
      margin: 0; 
      padding: 0; 
      height: 100%; 
      overflow: hidden; 
      background: #000;
      font-family: 'Courier Prime', monospace;
    }
    
    #map { 
      position: absolute; 
      top: 0; 
      left: 0; 
      right: 0; 
      bottom: 0; 
      z-index: 0;
    }
    
    .sidebar {
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 320px;
      background: rgba(0, 20, 0, 0.95);
      color: #0f0;
      overflow-y: auto;
      z-index: 1000;
      transition: transform 0.3s;
      border-right: 2px solid #0f0;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
    }
    .sidebar.collapsed { transform: translateX(-320px); }
    
    .sidebar-toggle {
      position: absolute;
      left: 330px;
      top: 20px;
      background: rgba(0, 20, 0, 0.95);
      color: #0f0;
      padding: 10px 15px;
      border: 2px solid #0f0;
      border-radius: 0 4px 4px 0;
      cursor: pointer;
      z-index: 1001;
      transition: all 0.3s;
      font-family: 'Courier Prime', monospace;
    }
    .sidebar-toggle:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    }
    .sidebar.collapsed + .sidebar-toggle { 
      left: 10px;
      border-radius: 4px;
    }
    
    .toolbar {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(0, 20, 0, 0.95);
      padding: 20px;
      border: 2px solid #0f0;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.3);
      z-index: 1000;
      max-width: 380px;
      color: #0f0;
    }
    
    .tool-btn {
      padding: 8px 12px;
      background: transparent;
      border: 2px solid #0f0;
      color: #0f0;
      font-family: 'Courier Prime', monospace;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .tool-btn:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.6);
    }
    .tool-btn.active {
      background: #0f0;
      color: #000;
    }
    
    .category-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid rgba(0, 255, 0, 0.2);
      display: flex;
      align-items: center;
      gap: 10px;
      transition: all 0.2s;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    .category-item:hover { 
      background: rgba(0, 255, 0, 0.1);
      border-left: 3px solid #0f0;
      padding-left: 13px;
    }
    .category-item.active { 
      background: rgba(0, 255, 0, 0.2);
      border-left: 3px solid #0f0;
      padding-left: 13px;
    }
    
    .shape-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: transparent;
      border: 2px solid #0f0;
      color: #0f0;
      cursor: pointer;
      transition: all 0.3s;
      margin-right: 8px;
    }
    .shape-btn:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.6);
    }
    .shape-btn.active {
      background: #0f0;
      color: #000;
    }
    
    .color-swatch {
      width: 32px;
      height: 32px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.3s;
      margin-right: 8px;
      margin-bottom: 8px;
    }
    .color-swatch:hover {
      transform: scale(1.1);
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
    }
    .color-swatch.active {
      border-color: #0f0;
      box-shadow: 0 0 10px #0f0;
    }
    
    .leaflet-container { background: #0a0a0a; }

    #watermark {
      position: fixed;
      bottom: 15px;
      right: 15px;
      width: 100px;
      opacity: 0.3;
      pointer-events: none;
      z-index: 9999;
      filter: brightness(0) saturate(100%) invert(48%) sepia(79%) saturate(2476%) hue-rotate(86deg) brightness(118%) contrast(119%);
    }

    .top-banner {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 1002;
      background: rgba(0, 20, 0, 0.95);
      color: #0f0;
      padding: 10px 16px;
      border: 2px solid #0f0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 2px;
      font-family: 'Courier Prime', monospace;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
    }

    #save-indicator {
      position: absolute;
      top: 20px;
      right: 420px;
      z-index: 1002;
      background: rgba(0, 255, 0, 0.9);
      color: #000;
      padding: 8px 14px;
      border: 2px solid #0f0;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Courier Prime', monospace;
      opacity: 0;
      transition: opacity 0.3s;
      pointer-events: none;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    }

    #save-indicator.saving {
      background: rgba(0, 255, 255, 0.9);
      border-color: #0ff;
      color: #000;
      opacity: 1;
    }

    #save-indicator.saved {
      background: rgba(0, 255, 0, 0.9);
      border-color: #0f0;
      color: #000;
      opacity: 1;
    }

    #dashboard-btn {
      position: absolute;
      top: 70px;
      left: 20px;
      z-index: 1003;
      background: rgba(0, 20, 0, 0.95);
      color: #0f0;
      padding: 10px 16px;
      border: 2px solid #0f0;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      font-family: 'Courier Prime', monospace;
      cursor: pointer;
      text-decoration: none;
      transition: all 0.3s;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.3);
    }

    #dashboard-btn:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 20px rgba(0, 255, 0, 0.6);
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 2px solid #0f0;
      text-align: center;
    }

    .sidebar-title {
      font-size: 16px;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
      text-shadow: 0 0 10px #0f0;
    }

    .sidebar-subtitle {
      font-size: 10px;
      opacity: 0.7;
      letter-spacing: 1px;
    }

    .section-label {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.7;
      margin-bottom: 8px;
      display: block;
    }

    .section-label::before {
      content: '> ';
    }

    .input-field {
      background: rgba(0, 0, 0, 0.6);
      border: 1px solid #0f0;
      color: #0f0;
      padding: 10px;
      width: 100%;
      font-family: 'Courier Prime', monospace;
      font-size: 12px;
      outline: none;
      transition: all 0.3s;
    }

    .input-field:focus {
      box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
      border-color: #0ff;
    }

    .input-field::placeholder {
      color: rgba(0, 255, 0, 0.4);
    }

    .btn-action {
      padding: 10px 16px;
      background: transparent;
      border: 2px solid #0f0;
      color: #0f0;
      font-family: 'Courier Prime', monospace;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      width: 100%;
      margin-bottom: 10px;
    }

    .btn-action:hover {
      background: #0f0;
      color: #000;
      box-shadow: 0 0 15px rgba(0, 255, 0, 0.6);
    }

    .btn-action.btn-red {
      border-color: #f00;
      color: #f00;
    }

    .btn-action.btn-red:hover {
      background: #f00;
      color: #000;
      box-shadow: 0 0 15px rgba(255, 0, 0, 0.6);
    }

    .toolbar-section {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 255, 0, 0.2);
    }

    .toolbar-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .blink {
      animation: blink 1s step-end infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0; }
    }
  </style>
</head>
<body>
  <!-- Watermark -->
  <img id="watermark" src="watermark.png" alt="Watermark">

  <!-- Top banner -->
  <div id="top-banner" class="top-banner">
    <span class="blink">‚ñà</span> PERSONAL MAP
  </div>

  <!-- Save indicator -->
  <div id="save-indicator">
    üíæ SAVING...
  </div>

  <!-- Dashboard button -->
  <a href="index.html" id="dashboard-btn">
    ‚¨Ö RETURN TO MAINFRAME
  </a>
  
  <!-- Sidebar -->
  <div id="sidebar" class="sidebar">
    <div class="sidebar-header">
      <div class="sidebar-title">üó∫Ô∏è TACTICAL MAP</div>
      <div class="sidebar-subtitle">PERSONAL INTELLIGENCE DATABASE</div>
    </div>
    
    <div style="padding: 20px;">
      <label class="section-label">CATEGORIES</label>
      <div id="categories">
        <div class="category-item" data-category="Crafting Locations">
          <i class="fas fa-gem"></i>
          <span>Collectibles</span>
        </div>
        <div class="category-item" data-category="Drug Processing">
          <i class="fas fa-gun"></i>
          <span>Ammu-Nation</span>
        </div>
        <div class="category-item" data-category="Other">
          <i class="fas fa-utensils"></i>
          <span>Food & Drink</span>
        </div>
      </div>
    </div>
  </div>
  
  <div class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars"></i>
  </div>

  <!-- Drawing Toolbar -->
  <div class="toolbar">
    <div style="text-align: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #0f0;">
      <div style="font-weight: bold; font-size: 14px; text-transform: uppercase; letter-spacing: 2px;">
        DRAWING TOOLS
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <!-- Tool Selection -->
      <div class="toolbar-section">
        <label class="section-label">TOOL MODE</label>
        <div style="display: flex; flex-wrap: wrap; gap: 8px;">
          <button id="tool-pan" class="tool-btn active">üñêÔ∏è PAN</button>
          <button id="tool-text" class="tool-btn">üìù TEXT</button>
          <button id="tool-draw" class="tool-btn">‚úèÔ∏è DRAW</button>
        </div>
      </div>
      
      <!-- Shape Tools -->
      <div class="toolbar-section">
        <label class="section-label">SHAPE MODE</label>
        <div style="display: flex; gap: 8px;">
          <div id="shape-rectangle" class="shape-btn" title="Rectangle">
            <i class="fas fa-square"></i>
          </div>
          <div id="shape-circle" class="shape-btn" title="Circle">
            <i class="fas fa-circle"></i>
          </div>
          <div id="shape-polygon" class="shape-btn" title="Polygon">
            <i class="fas fa-draw-polygon"></i>
          </div>
        </div>
      </div>
      
      <!-- Color Picker -->
      <div class="toolbar-section">
        <label class="section-label">COLOR SELECT</label>
        <div style="display: flex; flex-wrap: wrap;">
          <div class="color-swatch active" data-color="#ef4444" style="background: #ef4444;"></div>
          <div class="color-swatch" data-color="#3b82f6" style="background: #3b82f6;"></div>
          <div class="color-swatch" data-color="#10b981" style="background: #10b981;"></div>
          <div class="color-swatch" data-color="#f59e0b" style="background: #f59e0b;"></div>
          <div class="color-swatch" data-color="#8b5cf6" style="background: #8b5cf6;"></div>
          <input type="color" id="custom-color" value="#ef4444" class="color-swatch" style="padding: 0;" />
        </div>
      </div>
      
      <!-- Text Input -->
      <div class="toolbar-section">
        <label class="section-label">TEXT LABEL</label>
        <input type="text" id="text-input" placeholder="> ENTER TEXT..." value="Location" class="input-field" />
      </div>
      
      <!-- Actions -->
      <div>
        <button id="share-btn" class="btn-action">
          üîó SHARE MAP
        </button>
        <button id="clear-all" class="btn-action btn-red">
          üóëÔ∏è CLEAR ALL
        </button>
      </div>
    </div>
  </div>

  <!-- Map Container -->
  <div id="map"></div>

  <!-- MAIN SCRIPT WITH FIREBASE (MODULE) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { 
      getFirestore, 
      doc, 
      setDoc, 
      getDoc, 
      onSnapshot 
    } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
      authDomain: "the-saints-2f622.firebaseapp.com",
      projectId: "the-saints-2f622",
      storageBucket: "the-saints-2f622.firebasestorage.app",
      messagingSenderId: "131705359242",
      appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
      measurementId: "G-36PY404Q8N"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // Map + drawing state
    let map;
    let currentTool = "pan";
    let currentShape = null;
    let currentColor = "#ef4444";
    let isDrawing = false;
    let currentLineCoords = [];
    let polygonPoints = [];
    let lineFeatures = [];
    let shapeFeatures = [];
    let textMarkers = [];
    let isApplyingRemote = false;

    // Get logged in user
    const rawUser = localStorage.getItem("saintsUser");
    if (!rawUser) window.location.href = "login.html";

    let user;
    try {
      user = JSON.parse(rawUser);
    } catch {
      localStorage.removeItem("saintsUser");
      window.location.href = "login.html";
    }

    // Check if viewing someone else's map (for admins)
    const urlParams = new URLSearchParams(window.location.search);
    const viewingUsername = urlParams.get('user');
    
    // Determine which map to load
    let targetUsername = user.username;
    let isViewingOthersMap = false;
    
    if (viewingUsername && user.username === "Dante-Alberts") {
      targetUsername = viewingUsername;
      isViewingOthersMap = true;
    }

    const mapId = "personal-" + targetUsername;
    const mapDocRef = doc(db, "personalMaps", mapId);
    
    console.log('üó∫Ô∏è Personal Map ID:', mapId);
    console.log('üë§ Viewing as:', user.username);
    console.log('üìç Target user:', targetUsername);
    console.log('üëÅÔ∏è Viewing others map:', isViewingOthersMap);

    // AUTH / ROLE GUARD
    async function ensureAccess() {
      const raw = localStorage.getItem("saintsUser");
      if (!raw) {
        window.location.href = "login.html";
        return;
      }

      let sessionUser;
      try {
        sessionUser = JSON.parse(raw);
      } catch (e) {
        localStorage.removeItem("saintsUser");
        window.location.href = "login.html";
        return;
      }

      const userRef = doc(db, "users", sessionUser.username);
      const snap = await getDoc(userRef);

      if (!snap.exists()) {
        localStorage.removeItem("saintsUser");
        window.location.href = "login.html";
        return;
      }

      const data = snap.data();
      if (!data.approved) {
        window.location.href = "awaiting-approval.html";
        return;
      }

      const banner = document.getElementById("top-banner");
      if (isViewingOthersMap) {
        banner.innerHTML = `<span class="blink">‚ñà</span> ADMIN VIEW: ${targetUsername.toUpperCase()}'S MAP`;
        banner.style.borderColor = '#f00';
        banner.style.color = '#f00';
        banner.style.boxShadow = '0 0 15px rgba(255, 0, 0, 0.6)';
      } else {
        banner.innerHTML = `<span class="blink">‚ñà</span> PERSONAL MAP: ${sessionUser.username.toUpperCase()}`;
      }

      initMap();
      setupMapInteractions();
      initializeStorage();
    }

    function initMap() {
      map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -2,
        maxZoom: 4,
        maxNativeZoom: 4,
        center: [0, 0],
        zoom: 0,
        zoomSnap: 0.25,
        zoomDelta: 0.5
      });

      const bounds = [[-256, -256], [256, 256]];

      L.tileLayer('https://dukeofsussex.dev/projects/gta-v-map/maps/satellite/{z}/{x}/{y}.webp', {
        minZoom: -2,
        maxZoom: 4,
        maxNativeZoom: 4,
        noWrap: true,
        tileSize: 256,
        bounds: bounds,
        attribution: '¬© Rockstar Games | GTA V UHD Map'
      }).addTo(map);

      map.setMaxBounds(bounds);
      map.fitBounds(bounds);
    }

    function fixShapeForFirestore(shape) {
      const s = { ...shape };

      if (s.type === "rectangle" && Array.isArray(s.bounds)) {
        s.bounds = s.bounds.map(b => {
          if (Array.isArray(b)) {
            return { lat: b[0], lng: b[1] };
          }
          return { lat: b.lat, lng: b.lng };
        });
      }

      if (s.type === "circle" && s.center) {
        if (Array.isArray(s.center)) {
          s.center = { lat: s.center[0], lng: s.center[1] };
        } else {
          s.center = { lat: s.center.lat, lng: s.center.lng };
        }
      }

      if (s.type === "polygon" && Array.isArray(s.coordinates)) {
        s.coordinates = s.coordinates.map(p => {
          if (Array.isArray(p)) {
            return { lat: p[0], lng: p[1] };
          }
          return { lat: p.lat, lng: p.lng };
        });
      }

      return s;
    }

    function applyRemoteData(data) {
      isApplyingRemote = true;

      lineFeatures = Array.isArray(data.lines) ? data.lines : [];
      shapeFeatures = Array.isArray(data.shapes) ? data.shapes : [];

      textMarkers.forEach(t => t.markerInstance.remove());
      textMarkers = [];

      if (Array.isArray(data.labels)) {
        data.labels.forEach(label => {
          createTextMarker(label.lat, label.lng, label.text, label.color, label.id);
        });
      }

      redrawLines();
      redrawShapes();

      isApplyingRemote = false;
    }

    async function initializeStorage() {
      const existing = await getDoc(mapDocRef);
      if (existing.exists()) {
        const data = existing.data();
        if (data.username === targetUsername || !data.username) {
          applyRemoteData(data);
        }
      }

      onSnapshot(mapDocRef, (snapshot) => {
        if (!snapshot.exists()) return;
        const data = snapshot.data();
        
        if (data.username === targetUsername || !data.username) {
          applyRemoteData(data);
        }
      });
    }

    async function saveState() {
      if (!mapDocRef || isApplyingRemote) return;

      const indicator = document.getElementById('save-indicator');
      indicator.textContent = 'üíæ SAVING...';
      indicator.className = 'saving';

      const safeLines = lineFeatures.map(line => ({
        ...line,
        coordinates: Array.isArray(line.coordinates)
          ? line.coordinates.map(p => ({
              lat: p.lat,
              lng: p.lng
            }))
          : []
      }));

      const safeShapes = shapeFeatures.map(shape => fixShapeForFirestore(shape));

      const data = {
        lines: safeLines,
        shapes: safeShapes,
        labels: textMarkers.map(t => ({
          id: t.id,
          lat: t.lat,
          lng: t.lng,
          text: t.text,
          color: t.color
        })),
        username: targetUsername,
        lastUpdated: new Date().toISOString(),
        lastEditedBy: user.username
      };

      try {
        await setDoc(mapDocRef, data);
        console.log('‚úÖ Saved to Firebase:', data);
        
        indicator.textContent = '‚úÖ SAVED';
        indicator.className = 'saved';
        
        setTimeout(() => {
          indicator.style.opacity = '0';
        }, 2000);
      } catch (e) {
        console.error('‚ùå Save failed:', e);
        indicator.textContent = '‚ùå SAVE FAILED';
        indicator.style.background = 'rgba(255,0,0,0.9)';
        indicator.style.borderColor = '#f00';
        setTimeout(() => {
          indicator.style.opacity = '0';
        }, 3000);
      }
    }

    function setActiveTool(tool) {
      currentTool = tool;
      currentShape = null;
      polygonPoints = [];

      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));

      if (tool === 'pan') {
        document.getElementById('tool-pan').classList.add('active');
        if (map) map.dragging.enable();
      } else {
        if (map) map.dragging.disable();
        if (tool === 'draw') document.getElementById('tool-draw').classList.add('active');
        if (tool === 'text') document.getElementById('tool-text').classList.add('active');
      }
    }

    function setActiveShape(shape) {
      currentShape = shape;
      currentTool = 'shape';
      polygonPoints = [];

      document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelectorAll('.shape-btn').forEach(btn => btn.classList.remove('active'));

      if (shape === 'rectangle') document.getElementById('shape-rectangle').classList.add('active');
      if (shape === 'circle') document.getElementById('shape-circle').classList.add('active');
      if (shape === 'polygon') document.getElementById('shape-polygon').classList.add('active');

      if (map) map.dragging.disable();
    }

    document.getElementById('tool-pan').addEventListener('click', () => setActiveTool('pan'));
    document.getElementById('tool-draw').addEventListener('click', () => setActiveTool('draw'));
    document.getElementById('tool-text').addEventListener('click', () => setActiveTool('text'));
    document.getElementById('shape-rectangle').addEventListener('click', () => setActiveShape('rectangle'));
    document.getElementById('shape-circle').addEventListener('click', () => setActiveShape('circle'));
    document.getElementById('shape-polygon').addEventListener('click', () => setActiveShape('polygon'));

    document.querySelectorAll('.color-swatch').forEach(swatch => {
      swatch.addEventListener('click', () => {
        document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
        swatch.classList.add('active');
        if (swatch.dataset.color) {
          currentColor = swatch.dataset.color;
          document.getElementById('custom-color').value = currentColor;
        }
      });
    });

    document.getElementById('custom-color').addEventListener('input', (e) => {
      currentColor = e.target.value;
      document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('active'));
      e.target.classList.add('active');
    });

    document.getElementById('clear-all').addEventListener('click', async () => {
      if (!confirm('CLEAR ALL DRAWINGS?\n\nTHIS ACTION CANNOT BE UNDONE.')) return;
      lineFeatures = [];
      shapeFeatures = [];
      redrawLines();
      redrawShapes();
      textMarkers.forEach(t => t.markerInstance.remove());
      textMarkers = [];
      await saveState();
    });

    document.getElementById('share-btn').addEventListener('click', () => {
      const url = window.location.origin + window.location.pathname;
      navigator.clipboard.writeText(url);
      alert('MAP LINK COPIED TO CLIPBOARD');
    });

    function setupMapInteractions() {
      let tempShapeStart = null;

      map.on('mousedown', (e) => {
        if (currentTool === 'draw') {
          isDrawing = true;
          currentLineCoords = [{ lat: e.latlng.lat, lng: e.latlng.lng }];
        } else if (currentTool === 'shape' && (currentShape === 'rectangle' || currentShape === 'circle')) {
          tempShapeStart = e.latlng;
        }
      });

      map.on('mousemove', (e) => {
        if (isDrawing && currentTool === 'draw') {
          currentLineCoords.push({ lat: e.latlng.lat, lng: e.latlng.lng });
          redrawLines(true);
        }
      });

      map.on('mouseup', async (e) => {
        if (isDrawing && currentTool === 'draw') {
          isDrawing = false;
          if (currentLineCoords.length > 1) {
            lineFeatures.push({
              id: 'line-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              coordinates: currentLineCoords,
              color: currentColor
            });
            redrawLines();
            await saveState();
          }
          currentLineCoords = [];
        } else if (tempShapeStart && currentTool === 'shape') {
          if (currentShape === 'rectangle') {
            shapeFeatures.push({
              id: 'rect-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              type: 'rectangle',
              bounds: [
                { lat: tempShapeStart.lat, lng: tempShapeStart.lng },
                { lat: e.latlng.lat, lng: e.latlng.lng }
              ],
              color: currentColor
            });
          } else if (currentShape === 'circle') {
            const radius = map.distance(tempShapeStart, e.latlng);
            shapeFeatures.push({
              id: 'circle-' + Date.now() + '-' + Math.random().toString(36).slice(2),
              type: 'circle',
              center: { lat: tempShapeStart.lat, lng: tempShapeStart.lng },
              radius: radius,
              color: currentColor
            });
          }
          redrawShapes();
          await saveState();
          tempShapeStart = null;
        }
      });

      map.on('click', async (e) => {
        if (currentTool === 'text') {
          const text = document.getElementById('text-input').value || 'Location';
          createTextMarker(e.latlng.lat, e.latlng.lng, text, currentColor);
          await saveState();
        } else if (currentTool === 'shape' && currentShape === 'polygon') {
          polygonPoints.push({ lat: e.latlng.lat, lng: e.latlng.lng });
          if (polygonPoints.length >= 3) {
            setTimeout(async () => {
              if (confirm('COMPLETE POLYGON?')) {
                shapeFeatures.push({
                  id: 'poly-' + Date.now() + '-' + Math.random().toString(36).slice(2),
                  type: 'polygon',
                  coordinates: polygonPoints,
                  color: currentColor
                });
                redrawShapes();
                await saveState();
                polygonPoints = [];
              }
            }, 100);
          }
        }
      });
    }

    function redrawLines(includeTemp = false) {
      if (!map) return;

      map.eachLayer(layer => {
        if (layer.options && layer.options.isDrawnLine) {
          map.removeLayer(layer);
        }
      });

      lineFeatures.forEach(feature => {
        if (!Array.isArray(feature.coordinates)) return;
        const latlngs = feature.coordinates.map(p => [p.lat, p.lng]);
        const layer = L.polyline(latlngs, {
          color: feature.color,
          weight: 3,
          opacity: 0.9,
          isDrawnLine: true
        }).addTo(map);

        layer.on('click', async () => {
          if (confirm('DELETE THIS LINE?\n\nTHIS ACTION CANNOT BE UNDONE.')) {
            lineFeatures = lineFeatures.filter(f => f.id !== feature.id);
            redrawLines();
            await saveState();
          }
        });
      });

      if (includeTemp && currentLineCoords.length > 0) {
        const tempLatLngs = currentLineCoords.map(p => [p.lat, p.lng]);
        L.polyline(tempLatLngs, {
          color: currentColor,
          weight: 3,
          opacity: 0.6,
          isDrawnLine: true
        }).addTo(map);
      }
    }

    function redrawShapes() {
      if (!map) return;

      map.eachLayer(layer => {
        if (layer.options && layer.options.isDrawnShape) {
          map.removeLayer(layer);
        }
      });

      shapeFeatures.forEach(feature => {
        let layer;
        if (feature.type === 'rectangle' && Array.isArray(feature.bounds) && feature.bounds.length === 2) {
          const b = feature.bounds;
          const bounds = [
            [b[0].lat, b[0].lng],
            [b[1].lat, b[1].lng]
          ];
          layer = L.rectangle(bounds, {
            color: feature.color,
            fillColor: feature.color,
            fillOpacity: 0.3,
            weight: 2,
            isDrawnShape: true
          });
        } else if (feature.type === 'circle' && feature.center) {
          const center = [feature.center.lat, feature.center.lng];
          layer = L.circle(center, {
            radius: feature.radius,
            color: feature.color,
            fillColor: feature.color,
            fillOpacity: 0.3,
            weight: 2,
            isDrawnShape: true
          });
        } else if (feature.type === 'polygon' && Array.isArray(feature.coordinates)) {
          const coords = feature.coordinates.map(p => [p.lat, p.lng]);
          layer = L.polygon(coords, {
            color: feature.color,
            fillColor: feature.color,
            fillOpacity: 0.3,
            weight: 2,
            isDrawnShape: true
          });
        }
        
        if (layer) {
          layer.addTo(map);
          layer.on('click', async () => {
            if (confirm('DELETE THIS SHAPE?\n\nTHIS ACTION CANNOT BE UNDONE.')) {
              shapeFeatures = shapeFeatures.filter(f => f.id !== feature.id);
              redrawShapes();
              await saveState();
            }
          });
        }
      });
    }

    function createTextMarker(lat, lng, text, color, idOptional) {
      const id = idOptional || 'label-' + Date.now() + '-' + Math.random().toString(36).slice(2);

      const el = document.createElement('div');
      el.style.cssText = `
        padding: 6px 12px;
        background: ${color};
        color: #000;
        border: 2px solid ${color};
        border-radius: 4px;
        font-size: 12px;
        font-weight: 700;
        font-family: 'Courier Prime', monospace;
        text-transform: uppercase;
        letter-spacing: 1px;
        box-shadow: 0 0 10px ${color};
        cursor: pointer;
        white-space: nowrap;
      `;
      el.textContent = text;

      const marker = L.marker([lat, lng], {
        icon: L.divIcon({
          className: '',
          html: el.outerHTML,
          iconSize: null,
          iconAnchor: [0, 0]
        }),
        draggable: true
      }).addTo(map);

      const markerObj = { id, lat, lng, text, color, markerInstance: marker };

      marker.on('dragend', async () => {
        const pos = marker.getLatLng();
        markerObj.lat = pos.lat;
        markerObj.lng = pos.lng;
        await saveState();
      });

      marker.on('click', async () => {
        const action = prompt('EDIT TEXT (TYPE "DELETE" TO REMOVE):', markerObj.text);
        if (action === null) return;
        if (action.toUpperCase() === 'DELETE') {
          marker.remove();
          textMarkers = textMarkers.filter(t => t.id !== markerObj.id);
          await saveState();
        } else if (action.trim()) {
          markerObj.text = action.trim();
          marker.remove();
          textMarkers = textMarkers.filter(t => t.id !== markerObj.id);
          createTextMarker(markerObj.lat, markerObj.lng, markerObj.text, markerObj.color, markerObj.id);
          await saveState();
        }
      });

      textMarkers.push(markerObj);
      return markerObj;
    }

    window.toggleSidebar = function () {
      document.getElementById('sidebar').classList.toggle('collapsed');
    };

    document.querySelectorAll('.category-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.category-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        alert('CATEGORY MARKERS: ' + item.dataset.category);
      });
    });

    // Initialize everything
    ensureAccess();
  </script>
</body>
</html>
