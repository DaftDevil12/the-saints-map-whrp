<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>The Saints - Secure Login</title>
<script src="https://cdn.tailwindcss.com"></script>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
  import { 
    getFirestore, 
    doc, 
    setDoc, 
    getDoc 
  } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyA2U-NjxMLD0uu3HLT79RQYx-t8L9hK40M",
    authDomain: "the-saints-2f622.firebaseapp.com",
    projectId: "the-saints-2f622",
    storageBucket: "the-saints-2f622.firebasestorage.app",
    messagingSenderId: "131705359242",
    appId: "1:131705359242:web:92fa93f8a10a8ae34a5673",
    measurementId: "G-36PY404Q8N"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // SHA-256 hashing for passwords
  async function hash(text) {
    const encoder = new TextEncoder();
    const data = encoder.encode(text);
    const hashBuffer = await crypto.subtle.digest("SHA-256", data);
    return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // LOGIN HANDLER
  document.addEventListener("DOMContentLoaded", () => {
    const loginBtn = document.getElementById("login-btn");
    const signupBtn = document.getElementById("signup-btn");

    loginBtn.addEventListener("click", async () => {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;

      if (!user || !pass) {
        alert("Enter username and password.");
        return;
      }

      const ref = doc(db, "users", user);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        alert("User does not exist.");
        return;
      }

      const data = snap.data();
      const hashed = await hash(pass);

      if (hashed !== data.passwordHash) {
        alert("Incorrect password.");
        return;
      }

      if (!data.approved) {
        alert("Your account is not approved yet.");
        return;
      }

      // Save session
      localStorage.setItem("saintsUser", JSON.stringify({
        username: user,
        role: data.role
      }));

      window.location.href = "index.html";
    });

    // SIGNUP HANDLER
    signupBtn.addEventListener("click", async () => {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value;

      if (!user || !pass) {
        alert("Enter username & password.");
        return;
      }

      const ref = doc(db, "users", user);
      const snap = await getDoc(ref);

      if (snap.exists()) {
        alert("This username is already taken.");
        return;
      }

      const hashed = await hash(pass);

      await setDoc(ref, {
        username: user,
        passwordHash: hashed,
        approved: false,
        role: "user"
      });

      alert("Account created. Awaiting admin approval.");
    });
  });
</script>

<style>
  body {
    background: linear-gradient(180deg, #0b1120, #0d1b2a);
    height: 100vh;
    overflow: hidden;
    font-family: 'Orbitron', sans-serif;
  }
  .login-box {
    background: rgba(0,0,0,0.65);
    border: 2px solid #1e3a8a;
    box-shadow: 0px 0px 20px #1e3a8a;
    backdrop-filter: blur(6px);
  }
  #top-logo {
    width: 150px;
    opacity: 0.85;
  }
  #bottom-watermark {
    position: fixed;
    bottom: 10px;
    width: 100%;
    text-align: center;
    font-size: 13px;
    color: white;
    opacity: 0.55;
  }
</style>
</head>

<body class="flex items-center justify-center">

  <!-- TOP WATERMARK LOGO -->
  <img src="watermark.png" id="top-logo" class="absolute top-6">

  <div class="login-box p-8 rounded-lg text-white w-96 text-center">
    <h1 class="text-3xl font-bold mb-6">THE SAINTS ACCESS TERMINAL</h1>

    <input id="username" type="text" placeholder="USERNAME" class="w-full p-3 mb-3 bg-black text-white border border-blue-700 rounded">
    <input id="password" type="password" placeholder="PASSWORD" class="w-full p-3 mb-6 bg-black text-white border border-blue-700 rounded">

    <button id="login-btn" class="w-full py-3 mb-3 bg-blue-700 hover:bg-blue-600 font-bold">LOGIN</button>
    <button id="signup-btn" class="w-full py-2 bg-gray-700 hover:bg-gray-600 text-sm">REQUEST ACCOUNT</button>
  </div>

  <!-- Bottom watermark -->
  <div id="bottom-watermark">Made by Dante Alberts</div>

</body>
</html>
